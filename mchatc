#!/usr/bin/env bash
# Mobius Chat â€“ start the chat API server using shared venv.
# Expects worker to be running elsewhere (e.g. mchatcw or mstart).
set -e

# Resolve symlinks to find repo dir
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
REPO_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
MOBIUS_ROOT="$(cd -P "$REPO_DIR/.." && pwd)"
VENV="$MOBIUS_ROOT/.venv"

cd "$REPO_DIR"

# Load .env
if [[ -f "$REPO_DIR/.env" ]]; then
  set -a
  source "$REPO_DIR/.env"
  set +a
fi

export QUEUE_TYPE="${QUEUE_TYPE:-redis}"
export REDIS_URL="${REDIS_URL:-redis://10.40.102.67:6379/0}"

# Check for shared venv
if [ ! -d "$VENV" ]; then
  echo "[mchatc] No shared venv at $VENV. Create it:"
  echo "  cd $MOBIUS_ROOT && python3.11 -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt"
  exit 1
fi

exec "$VENV/bin/python3" -m uvicorn app.main:app --host 0.0.0.0 --port 8000 "$@"
